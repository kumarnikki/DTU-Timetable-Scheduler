<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DTU Timetable Scheduler</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="timetable.svg" />
  </head>
  <body>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <div class="glass auth-container" style="margin-top: 5vh; min-width: 400px;">
      <div class="logo" style="margin-bottom: 2rem;">DTU Scheduler</div>

      <!-- Auth Toggle -->
      <div class="auth-toggle" style="display: flex; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 25px; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.1);">
         <button onclick="switchAuthState('login')" id="toggle-login-btn" class="active" style="flex:1; padding: 8px; border-radius: 20px; border: none; background: var(--primary); color: white; cursor: pointer; transition: 0.3s; font-weight: 500;">Login</button>
         <button onclick="switchAuthState('register')" id="toggle-register-btn" style="flex:1; padding: 8px; border-radius: 20px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; transition: 0.3s; font-weight: 500;">Sign Up</button>
      </div>

      <!-- Login View -->
      <div id="login-view" class="auth-form" style="text-align: center;">
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem;">Welcome back!</h2>
        <p style="color:var(--text-muted); margin-bottom: 2rem;">Sign in with your Google account to continue.</p>
        
        <!-- Google Button -->
        <div id="g_id_onload"
             data-client_id="172073707110-obe0voq806ffr2n2jthgl6tnclbsde8g.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleGoogleSignIn"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" style="display: flex; justify-content: center;"></div>

        <div style="margin: 1.5rem 0; display: flex; align-items: center; color: var(--text-muted); font-size: 0.8rem;">
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
            <div style="padding: 0 10px;">OR</div>
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
        </div>

        <form onsubmit="handleManualLogin(event)">
            <div class="form-group" style="text-align: left;">
                <label>Email</label>
                <input type="email" name="email" placeholder="xyz@gmail.com" required />
            </div>
            <div class="form-group" style="text-align: left;">
                <label>Password</label>
                <input type="password" name="password" placeholder="••••••" required />
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
        </form>
      </div>

      <!-- Register View (Hidden by default) -->
      <div id="register-view" class="auth-form hidden" style="text-align: center;">
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem;">Create your account</h2>
        <p style="color:var(--text-muted); margin-bottom: 2rem;">Sign up with Google for a faster setup.</p>
        
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signup_with" data-size="large" data-logo_alignment="left" style="display: flex; justify-content: center;"></div>

        <div style="margin: 1.5rem 0; display: flex; align-items: center; color: var(--text-muted); font-size: 0.8rem;">
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
            <div style="padding: 0 10px;">OR</div>
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
        </div>

        <form onsubmit="handleManualRegister(event)" style="text-align: left;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="name" required />
                </div>
                <div class="form-group">
                    <label>Roll No</label>
                    <input type="text" name="rollNo" placeholder="2K24/..." required />
                </div>
            </div>
            <div class="form-group">
                <label>Email ID</label>
                <input type="email" name="email" required />
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Branch</label>
                    <select name="branch" id="reg-branch-manual" onchange="loadSectionsManual()" required>
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <select name="semester" required>
                        <option value="1">1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="6">6th</option>
                        <option value="7">7th</option>
                        <option value="8">8th</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Section</label>
                <select name="section" id="reg-section-manual" required>
                    <option value="">Select Section</option>
                </select>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Create Account</button>
        </form>
      </div>

      <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
        <p style="color:var(--text-muted); font-size: 0.75rem;">
            By continuing, you agree to the usage of your email for timetable synchronization.
        </p>
      </div>
    </div>

    <!-- Profile Completion Modal (For New Google Users) -->
    <div id="profile-completion-modal" class="modal-overlay hidden">
        <div class="modal glass">
            <h2 style="margin-bottom:0.5rem;">Almost Done!</h2>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Please complete your profile to see your timetable.</p>
            
            <form onsubmit="handleProfileCompletion(event)">
                <div class="form-group">
                    <label>Roll No</label>
                    <input type="text" name="rollNo" placeholder="2K24/CSE/01" required />
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <select name="semester" required>
                        <option value="">Select Semester</option>
                        <option value="1">1st Semester</option>
                        <option value="2">2nd Semester</option>
                        <option value="3">3rd Semester</option>
                        <option value="4">4th Semester</option>
                        <option value="5">5th Semester</option>
                        <option value="6">6th Semester</option>
                        <option value="7">7th Semester</option>
                        <option value="8">8th Semester</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <select name="branch" id="reg-branch" onchange="loadSections()" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select name="section" id="reg-section" required>
                        <option value="">Select Section</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Complete Setup</button>
            </form>
        </div>
    </div>


    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script>
      // Global Error Handler for Debugging
      window.onerror = function(message, source, lineno, colno, error) {
          alert("JS ERROR: " + message + " at " + lineno + ":" + colno);
          return false;
      };

      function switchAuthState(state) {
          const isLogin = state === 'login';
          document.getElementById('login-view').classList.toggle('hidden', !isLogin);
          document.getElementById('register-view').classList.toggle('hidden', isLogin);
          
          // Toggle Buttons
          const loginBtn = document.getElementById('toggle-login-btn');
          const registerBtn = document.getElementById('toggle-register-btn');
          
          if(isLogin) {
              loginBtn.classList.add('active');
              loginBtn.style.background = 'var(--primary)';
              loginBtn.style.color = 'white';
              registerBtn.classList.remove('active');
              registerBtn.style.background = 'transparent';
              registerBtn.style.color = 'var(--text-muted)';
          } else {
              registerBtn.classList.add('active');
              registerBtn.style.background = 'var(--primary)';
              registerBtn.style.color = 'white';
              loginBtn.classList.remove('active');
              loginBtn.style.background = 'transparent';
              loginBtn.style.color = 'var(--text-muted)';
              populateBranchesManual();
          }
      }

      // Global callback for Google Sign-In
      function handleGoogleSignIn(response) {
          Auth.handleGoogleSignIn(response);
      }

      // Manual Flow Handlers
      function handleManualLogin(e) {
          e.preventDefault();
          try {
              const formData = new FormData(e.target);
              const email = formData.get('email');
              const password = formData.get('password');
              
              if(!email || !password) return alert("Please enter both email and password.");

              const result = Auth.login(email, password);
              if (result && result.success) {
                  Auth.sessionLogin(result.user);
              } else {
                  alert(result.message || "Invalid email or password.");
              }
          } catch (err) {
              console.error("Login Handler Error:", err);
              alert("An error occurred during login. Please refresh and try again.");
          }
      }

      function handleManualRegister(e) {
          e.preventDefault();
          try {
              const formData = new FormData(e.target);
              const details = Object.fromEntries(formData.entries());
              
              const result = Auth.register(details);
              if (result && result.success) {
                  alert("Account created successfully!");
                  Auth.sessionLogin({ ...details, role: 'student', id: details.rollNo });
              } else {
                  alert(result.error || result.message || "Registration failed.");
              }
          } catch (err) {
              console.error("Register Handler Error:", err);
              alert("An error occurred during registration.");
          }
      }

      function handleProfileCompletion(e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const details = Object.fromEntries(formData.entries());

          const result = Auth.registerGoogleUser(details);
          if (result.success) {
              alert("Profile completed! Welcome to DTU Scheduler.");
          } else {
              alert(result.message || "Failed to save profile.");
          }
      }

      // Population Helpers
      function populateBranches() {
        // Modal Branch Population
        const select = document.getElementById("reg-branch");
        if (!select || select.options.length > 1) return;
        BRANCHES.forEach(b => addOption(select, b));
      }

      function populateBranchesManual() {
        // Main Form Branch Population
        const select = document.getElementById("reg-branch-manual");
        if (!select || select.options.length > 1) return;
        BRANCHES.forEach(b => addOption(select, b));
      }

      function addOption(select, b) {
          const opt = document.createElement("option");
          const matches = b.match(/\(([^)]+)\)$/);
          opt.value = matches ? matches[1] : b;
          opt.textContent = b;
          select.appendChild(opt);
      }

      function loadSections() {
          const branch = document.getElementById("reg-branch").value;
          updateSectionSelect(document.getElementById("reg-section"), branch);
      }

      function loadSectionsManual() {
          const branch = document.getElementById("reg-branch-manual").value;
          updateSectionSelect(document.getElementById("reg-section-manual"), branch);
      }

      function updateSectionSelect(select, branch) {
          select.innerHTML = '<option value="">Select Section</option>';
          const sections = SECTIONS[branch] || SECTIONS['default'];
          if (sections) {
              sections.forEach(s => {
                  const opt = document.createElement("option");
                  opt.value = opt.textContent = s;
                  select.appendChild(opt);
              });
          }
      }

      window.onload = () => {
          populateBranches(); // For modal
      };
    </script>

  </body>
</html>
