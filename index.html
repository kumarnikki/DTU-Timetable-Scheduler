<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DTU Timetable Scheduler</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="timetable.svg" />
  </head>
  <body>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <div class="glass auth-container" style="margin-top: 5vh">
      <div class="logo">DTU Scheduler</div>

      <!-- Main Login Section -->
      <div id="auth-main" class="auth-form" style="text-align: center; padding: 2rem 0;">
        <h2 style="margin-bottom: 0.5rem;">Welcome back!</h2>
        <p style="color:var(--text-muted); margin-bottom: 2rem;">Sign in with your Google account to continue.</p>
        
        <!-- Google Sign-In Button Container -->
        <div id="g_id_onload"
             data-client_id="172073707110-obe0voq806ffr2n2jthgl6tnclbsde8g.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleGoogleSignIn"
             data-auto_prompt="false">
        </div>

        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left"
             style="display: flex; justify-content: center;">
        </div>

        <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
            <p style="color:var(--text-muted); font-size: 0.85rem;">
                By signing in, you agree to the usage of your DTU email for timetable synchronization.
            </p>
        </div>
      </div>
    </div>

    <!-- Profile Completion Modal (For New Google Users) -->
    <div id="profile-completion-modal" class="modal-overlay hidden">
        <div class="modal glass">
            <h2 style="margin-bottom:0.5rem;">Almost Done!</h2>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Please complete your profile to see your timetable.</p>
            
            <form onsubmit="handleProfileCompletion(event)">
                <div class="form-group">
                    <label>Roll No</label>
                    <input type="text" name="rollNo" placeholder="2K24/CSE/01" required />
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <select name="semester" required>
                        <option value="">Select Semester</option>
                        <option value="1">1st Semester</option>
                        <option value="2">2nd Semester</option>
                        <option value="3">3rd Semester</option>
                        <option value="4">4th Semester</option>
                        <option value="5">5th Semester</option>
                        <option value="6">6th Semester</option>
                        <option value="7">7th Semester</option>
                        <option value="8">8th Semester</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <select name="branch" id="reg-branch" onchange="loadSections()" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select name="section" id="reg-section" required>
                        <option value="">Select Section</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Complete Setup</button>
            </form>
        </div>
    </div>


    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script>
      // Global callback for Google Sign-In (called by Google library)
      function handleGoogleSignIn(response) {
          Auth.handleGoogleSignIn(response);
      }

      function handleProfileCompletion(e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const details = Object.fromEntries(formData.entries());

          const result = Auth.registerGoogleUser(details);
          if (result.success) {
              alert("Profile completed! Welcome to DTU Scheduler.");
          } else {
              alert(result.message || "Failed to save profile.");
          }
      }

      // Helper for UI
      function populateBranches() {
        const select = document.getElementById("reg-branch");
        if (select.options.length > 1) return; // already populated
        BRANCHES.forEach((b) => {
          const opt = document.createElement("option");
          const matches = b.match(/\(([^)]+)\)$/);
          const code = matches ? matches[1] : b;
          opt.value = code;
          opt.textContent = b;
          select.appendChild(opt);
        });
      }

      function loadSections() {
        const branch = document.getElementById("reg-branch").value;
        const sectionSelect = document.getElementById("reg-section");
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        const sections = SECTIONS[branch] || SECTIONS['default'];
        if (sections) {
          sections.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s;
            opt.textContent = s;
            sectionSelect.appendChild(opt);
          });
        }
      }

      // Initialize
      window.onload = () => {
          populateBranches();
      };
    </script>

  </body>
</html>
