<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DTU Timetable Scheduler</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="timetable.svg" />
  </head>
  <body>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <div class="glass auth-container" style="margin-top: 5vh;">
      <div class="logo" style="margin-bottom: 2rem;">DTU Scheduler</div>

      <!-- Auth Toggle -->
      <div class="auth-toggle">
         <button onclick="switchAuthState('login')" id="toggle-login-btn" class="active">Login</button>
         <button onclick="switchAuthState('register')" id="toggle-register-btn">Sign Up</button>
      </div>

      <!-- Login View -->
      <div id="login-view" class="auth-form" style="text-align: center;">
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem;">Welcome back!</h2>
        <p style="color:var(--text-muted); margin-bottom: 2rem;">Sign in with your Google account to continue.</p>
        
        <!-- Google Button -->
        <div id="g_id_onload"
             data-client_id="172073707110-obe0voq806ffr2n2jthgl6tnclbsde8g.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleGoogleSignIn"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" style="display: flex; justify-content: center;"></div>

        <div style="margin: 2rem 0; display: flex; align-items: center; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; letter-spacing: 1px;">
            <div style="flex:1; height:1px; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1));"></div>
            <div style="padding: 0 15px;">OR</div>
            <div style="flex:1; height:1px; background: linear-gradient(to left, transparent, rgba(255,255,255,0.1));"></div>
        </div>

        <form onsubmit="handleManualLogin(event)">
            <div class="form-group" style="text-align: left;">
                <label>Email</label>
                <input type="email" name="email" placeholder="xyz@gmail.com" required />
            </div>
            <div class="form-group" style="text-align: left;">
                <label>Password</label>
                <input type="password" name="password" placeholder="••••••" required />
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
        </form>
      </div>

      <!-- Register View (Hidden by default) -->
      <div id="register-view" class="auth-form hidden" style="text-align: center;">
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem;">Create your account</h2>
        <p style="color:var(--text-muted); margin-bottom: 2rem;">Sign up with Google for a faster setup.</p>
        
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signup_with" data-size="large" data-logo_alignment="left" style="display: flex; justify-content: center;"></div>

        <div style="margin: 1.5rem 0; display: flex; align-items: center; color: var(--text-muted); font-size: 0.8rem;">
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
            <div style="padding: 0 10px;">OR</div>
            <div style="flex:1; height:1px; background: rgba(255,255,255,0.1);"></div>
        </div>

        <form onsubmit="handleManualRegister(event)" style="text-align: left;">
            <div class="form-group">
                <label>Register as</label>
                <select name="role" id="reg-role" onchange="toggleRoleFields(this.value, 'manual')" required>
                    <option value="student">Student</option>
                    <option value="professor">Professor</option>
                    <option value="warden_hostel">Hostel Warden</option>
                    <option value="warden_mess">Mess Warden</option>
                </select>
            </div>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="name" required />
            </div>

            <div class="form-group">
                <label>Email ID</label>
                <input type="email" name="email" required />
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required />
            </div>

            <!-- Student Specific Fields -->
            <div id="fields-student-manual">
                <div class="form-group">
                    <label>Roll No</label>
                    <input type="text" name="rollNo" id="reg-rollNo-manual" placeholder="2K24/..." required />
                </div>
                <div class="grid-responsive">
                    <div class="form-group">
                        <label>Branch</label>
                        <select name="branch" id="reg-branch-manual" onchange="loadSectionsManual()" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <select name="semester">
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select name="section" id="reg-section-manual" required>
                        <option value="">Select Section</option>
                    </select>
                </div>
            </div>

            <!-- Professor Specific Fields -->
            <div id="fields-professor-manual" class="hidden">
                <div class="form-group">
                    <label>Department</label>
                    <select name="dept" id="reg-dept-manual">
                        <option value="CSE">Computer Science</option>
                        <option value="ECE">Electronics & Comm</option>
                        <option value="EE">Electrical Eng</option>
                        <option value="ME">Mechanical Eng</option>
                        <option value="CE">Civil Eng</option>
                        <option value="IT">Information Tech</option>
                    </select>
                </div>
            </div>

            <!-- Warden Specific Fields -->
            <div id="fields-warden-manual" class="hidden">
                <div class="form-group">
                    <label>Hostel / Mess Name</label>
                    <input type="text" name="hostel" id="reg-hostel-manual" placeholder="e.g. Aryabhatta" />
                </div>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Create Account</button>
        </form>
      </div>

      <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
        <p style="color:var(--text-muted); font-size: 0.75rem;">
            By continuing, you agree to the usage of your email for timetable synchronization.
        </p>
      </div>
    </div>

    <!-- Profile Completion Modal (For New Google Users) -->
    <div id="profile-completion-modal" class="modal-overlay hidden">
        <div class="modal glass">
            <h2 style="margin-bottom:0.5rem;">Almost Done!</h2>
            <p style="color:var(--text-muted); margin-bottom:1.5rem;">Please complete your profile to see your timetable.</p>
            
            <form onsubmit="handleProfileCompletion(event)">
                <div class="form-group">
                    <label>I am a...</label>
                    <select name="role" id="modal-role" onchange="toggleRoleFields(this.value, 'modal')" required>
                        <option value="student">Student</option>
                        <option value="professor">Professor</option>
                        <option value="warden_hostel">Hostel Warden</option>
                        <option value="warden_mess">Mess Warden</option>
                    </select>
                </div>

                <!-- Student Specific -->
                <div id="fields-student-modal">
                    <div class="form-group">
                        <label>Roll No</label>
                        <input type="text" name="rollNo" id="reg-rollNo-modal" placeholder="2K24/CSE/01" required />
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <select name="semester" id="reg-sem-modal" required>
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                            <option value="7">7th Semester</option>
                            <option value="8">8th Semester</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Branch</label>
                        <select name="branch" id="reg-branch" onchange="loadSections()" required>
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Section</label>
                        <select name="section" id="reg-section" required>
                            <option value="">Select Section</option>
                        </select>
                    </div>
                </div>

                <!-- Professor Specific -->
                <div id="fields-professor-modal" class="hidden">
                    <div class="form-group">
                        <label>Department</label>
                        <select name="dept" id="reg-dept-modal">
                            <option value="CSE">Computer Science</option>
                            <option value="ECE">Electronics & Comm</option>
                            <option value="EE">Electrical Eng</option>
                            <option value="ME">Mechanical Eng</option>
                            <option value="CE">Civil Eng</option>
                            <option value="IT">Information Tech</option>
                        </select>
                    </div>
                </div>

                <!-- Warden Specific -->
                <div id="fields-warden-modal" class="hidden">
                    <div class="form-group">
                        <label>Hostel / Mess Name</label>
                        <input type="text" name="hostel" id="reg-hostel-modal" placeholder="e.g. Aryabhatta" />
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="width:100%;">Complete Setup</button>
            </form>
        </div>
    </div>


    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script>
      // Global Error Handler for Debugging
      window.onerror = function(message, source, lineno, colno, error) {
          alert("JS ERROR: " + message + " at " + lineno + ":" + colno);
          return false;
      };

      function switchAuthState(state) {
          const isLogin = state === 'login';
          document.getElementById('login-view').classList.toggle('hidden', !isLogin);
          document.getElementById('register-view').classList.toggle('hidden', isLogin);
          
          document.getElementById('toggle-login-btn').classList.toggle('active', isLogin);
          document.getElementById('toggle-register-btn').classList.toggle('active', !isLogin);
          
          if(!isLogin) {
              populateBranchesManual();
              toggleRoleFields('student', 'manual'); // Reset to student manually
          }
      }

      function toggleRoleFields(role, type) {
          const suffix = '-' + type;
          
          // Visibility
          document.getElementById('fields-student' + suffix).classList.toggle('hidden', role !== 'student');
          document.getElementById('fields-professor' + suffix).classList.toggle('hidden', role !== 'professor');
          document.getElementById('fields-warden' + suffix).classList.toggle('hidden', !role.startsWith('warden'));

          // Update Required Attributes
          const setReq = (id, req) => {
              const el = document.getElementById(id);
              if(el) el.required = req;
          };

          if(type === 'manual') {
              setReq('reg-rollNo-manual', role === 'student');
              setReq('reg-branch-manual', role === 'student');
              setReq('reg-section-manual', role === 'student');
              // Professor
              setReq('reg-dept-manual', role === 'professor');
              // Warden
              setReq('reg-hostel-manual', role.startsWith('warden'));
          } else {
              setReq('reg-rollNo-modal', role === 'student');
              setReq('reg-sem-modal', role === 'student');
              setReq('reg-branch', role === 'student');
              setReq('reg-section', role === 'student');
              // Professor
              setReq('reg-dept-modal', role === 'professor');
              // Warden
              setReq('reg-hostel-modal', role.startsWith('warden'));
          }
      }

      // Global callback for Google Sign-In
      function handleGoogleSignIn(response) {
          Auth.handleGoogleSignIn(response);
      }

      // Manual Flow Handlers
      function handleManualLogin(e) {
          e.preventDefault();
          try {
              const formData = new FormData(e.target);
              const email = formData.get('email');
              const password = formData.get('password');
              
              if(!email || !password) return alert("Please enter both email and password.");

              const result = Auth.login(email, password);
              if (result && result.success) {
                  Auth.sessionLogin(result.user);
              } else {
                  alert(result.message || "Invalid email or password.");
              }
          } catch (err) {
              console.error("Login Handler Error:", err);
              alert("An error occurred during login. Please refresh and try again.");
          }
      }

      function handleManualRegister(e) {
          e.preventDefault();
          try {
              const formData = new FormData(e.target);
              const details = Object.fromEntries(formData.entries());
              
              const result = Auth.register(details);
              if (result && result.success) {
                  alert("Account created successfully!");
                  Auth.sessionLogin({ ...details, role: 'student', id: details.rollNo });
              } else {
                  alert(result.error || result.message || "Registration failed.");
              }
          } catch (err) {
              console.error("Register Handler Error:", err);
              alert("An error occurred during registration.");
          }
      }

      function handleProfileCompletion(e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const details = Object.fromEntries(formData.entries());

          const result = Auth.registerGoogleUser(details);
          if (result.success) {
              alert("Profile completed! Welcome to DTU Scheduler.");
          } else {
              alert(result.message || "Failed to save profile.");
          }
      }

      // Population Helpers
      function populateBranches() {
        // Modal Branch Population
        const select = document.getElementById("reg-branch");
        if (!select || select.options.length > 1) return;
        BRANCHES.forEach(b => addOption(select, b));
      }

      function populateBranchesManual() {
        // Main Form Branch Population
        const select = document.getElementById("reg-branch-manual");
        if (!select || select.options.length > 1) return;
        BRANCHES.forEach(b => addOption(select, b));
      }

      function addOption(select, b) {
          const opt = document.createElement("option");
          const matches = b.match(/\(([^)]+)\)$/);
          opt.value = matches ? matches[1] : b;
          opt.textContent = b;
          select.appendChild(opt);
      }

      function loadSections() {
          const branch = document.getElementById("reg-branch").value;
          updateSectionSelect(document.getElementById("reg-section"), branch);
      }

      function loadSectionsManual() {
          const branch = document.getElementById("reg-branch-manual").value;
          updateSectionSelect(document.getElementById("reg-section-manual"), branch);
      }

      function updateSectionSelect(select, branch) {
          select.innerHTML = '<option value="">Select Section</option>';
          const sections = SECTIONS[branch] || SECTIONS['default'];
          if (sections) {
              sections.forEach(s => {
                  const opt = document.createElement("option");
                  opt.value = opt.textContent = s;
                  select.appendChild(opt);
              });
          }
      }

      window.onload = () => {
          populateBranches(); // For modal
      };
    </script>

  </body>
</html>
